name: Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  php-lint:
    name: PHP Syntax Check
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php: ['7.4', '8.0', '8.1', '8.2']

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: parallel-lint

      - name: Run PHP lint
        run: parallel-lint --exclude vendor --exclude node_modules .

  prettier:
    name: Prettier (JS/CSS)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Run Prettier
        run: npm run format:check || echo "::warning::Prettier formatting issues found. Run 'npm run format' to fix."

  version-check:
    name: Version Consistency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check version consistency
        run: |
          # Extract versions using grep
          PLUGIN_VERSION=$(grep -E "^\s*\*\s*Version:" ai-crm-form.php | head -1 | sed 's/.*Version:\s*//' | tr -d '[:space:]')
          CONSTANT_VERSION=$(grep "AICRMFORM_VERSION" ai-crm-form.php | head -1 | sed "s/.*'\([0-9.]*\)'.*/\1/")
          README_VERSION=$(grep "Stable tag:" readme.txt | head -1 | sed 's/.*Stable tag:\s*//' | tr -d '[:space:]')
          PACKAGE_VERSION=$(grep '"version"' package.json | head -1 | sed 's/.*"\([0-9.]*\)".*/\1/')
          COMPOSER_VERSION=$(grep '"version"' composer.json | head -1 | sed 's/.*"\([0-9.]*\)".*/\1/')
          
          echo "Plugin header version: $PLUGIN_VERSION"
          echo "Constant version: $CONSTANT_VERSION"
          echo "readme.txt version: $README_VERSION"
          echo "package.json version: $PACKAGE_VERSION"
          echo "composer.json version: $COMPOSER_VERSION"
          
          # Check if all match
          if [ "$PLUGIN_VERSION" != "$CONSTANT_VERSION" ] || \
             [ "$PLUGIN_VERSION" != "$README_VERSION" ] || \
             [ "$PLUGIN_VERSION" != "$PACKAGE_VERSION" ] || \
             [ "$PLUGIN_VERSION" != "$COMPOSER_VERSION" ]; then
            echo "::warning::Version mismatch detected. Please ensure all version numbers are consistent."
            echo "Expected all to be: $PLUGIN_VERSION"
          else
            echo "âœ… All versions match: $PLUGIN_VERSION"
          fi
